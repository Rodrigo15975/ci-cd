name: CI/CD to AWS ECR (Production Only)

on:
  push:
    branches: ['master']

permissions:
  contents: write # â† Esto es necesario para poder hacer git push(obtener versionado opcinal)

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      # Step 1: Checkout code
      - name: ğŸ§¾ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      #  Obtener y generar nueva versiÃ³n
      - name: ğŸ·ï¸ Obtener y generar nueva versiÃ³n
        id: semver
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Ãšltimo tag encontrado: $LAST_TAG"

          # Extrae versiÃ³n semÃ¡ntica
          VERSION=$(echo "$LAST_TAG" | sed 's/v//')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Buscar un nuevo tag que no exista
          while true; do
            PATCH=$((PATCH + 1))
            NEW_VERSION="v$MAJOR.$MINOR.$PATCH"

            # Verifica si ya existe en remoto
            if ! git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
              break
            fi
          done

          echo "Nueva versiÃ³n: $NEW_VERSION"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Etiquetamos y pusheamos
          git tag $NEW_VERSION
          git push origin $NEW_VERSION

          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      # Obtener el commit short SHA(optinal- for versioning)
      - name: Set short git commit SHA
        id: commit
        uses: prompt/actions-commit-hash@v2

      # Step 2: Set up Node.js
      - name: âš™ï¸ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      # Step 3: Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¥ Instalando dependencias..."
          npm install

      # Step 4: Build NestJS application
      - name: ğŸ”§ Build application
        run: |
          echo "ğŸ”¨ Construyendo aplicaciÃ³n NestJS..."
          npm run build

      # Step 5: Configure AWS credentials
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{secrets.AWS_REGION}}

      # Step 6: Log in to Amazon ECR
      - name: ğŸ”‘ Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Step 7: Build, tag, and push Docker image to ECR
      - name: ğŸš€ Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }} # â† URL de tu repositorio ECR, por ejemplo: 222634373780.dkr.ecr.us-east-1.amazonaws.com
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }} # â† Nombre del repositorio en ECR, por ejemplo: api-gateway
          SHORT_COMMIT: ${{ steps.commit.outputs.short }}
          VERSION: ${{ steps.semver.outputs.version }}
          TAG_FINAL: ${{ steps.semver.outputs.version }}-${{ steps.commit.outputs.short }}
        run: |
          echo "ğŸš§ Construyendo imagen Docker con versiÃ³n: $TAG_FINAL"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$TAG_FINAL .

          echo "ğŸ“¤ Subiendo imagen: $TAG_FINAL"
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$TAG_FINAL

          echo "âœ… Imagen construida y subida a ECR."

        # 8. Update kubeconfig for EKS
      - name: Update kubeconfig
        run: |
          echo "ğŸš€ Actualizando kubeconfig..."
          aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}

        # 9. Update deployment in EKS(Kubernetes)
      - name: ğŸš¢ Actualizar deployment en Kubernetes con nueva imagen
        run: |
          echo "ğŸ”„ Actualizando deployment con nueva imagen: $VERSION"
          kubectl set image deployment/${{ secrets.K8S_DEPLOYMENT_NAME }} \
            ${{ secrets.K8S_CONTAINER_NAME }}=$ECR_REGISTRY/$ECR_REPOSITORY:$VERSION \
            --namespace=${{ secrets.K8S_NAMESPACE }}
          echo "âœ… Deployment actualizado en Kubernetes."

          # 10. Verificar si el deployment fue exitoso
      - name: âœ… Verificar rollout del deployment
        run: |
          echo "ğŸ” Verificando que el deployment se haya aplicado correctamente..."
          kubectl rollout status deployment/${{ secrets.K8S_DEPLOYMENT_NAME }} --namespace=${{ secrets.K8S_NAMESPACE }}
          echo "ğŸ‰ Rollout completado correctamente."
